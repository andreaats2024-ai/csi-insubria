<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• CSI - Sistema di Autenticazione ATS Insubria</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ==================== LOGIN SCREEN ==================== */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            flex-direction: column;
            gap: 20px;
        }

        #loginScreen.hidden {
            display: none;
        }

        .login-wrapper {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
            flex-wrap: wrap;
            justify-content: center;
        }

        .login-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            animation: slideIn 0.5s ease;
        }

        .users-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            padding: 40px;
            animation: slideIn 0.5s ease;
            max-height: 600px;
            overflow-y: auto;
        }

        @keyframes slideIn {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .users-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
        }

        .users-header h2 {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input::placeholder {
            color: #999;
        }

        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .remember-forgot input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .remember-forgot label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: #333;
        }

        .forgot-password {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .login-btn, .btn-add-user, .btn-export, .btn-import, .btn-delete-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .login-btn:hover, .btn-add-user:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active, .btn-add-user:active {
            transform: translateY(0);
        }

        .login-divider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            color: #999;
            font-size: 13px;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
        }

        .guest-login {
            display: flex;
            gap: 10px;
        }

        .guest-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .guest-btn:hover {
            background: #f5f7ff;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .user-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        .user-info {
            flex: 1;
            cursor: pointer;
            padding: 8px;
        }

        .user-email {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .user-role {
            color: #666;
            font-size: 12px;
            margin-top: 2px;
        }

        .user-org {
            color: #999;
            font-size: 11px;
            margin-top: 2px;
        }

        .btn-delete-user {
            background: #e74c3c;
            padding: 8px 12px;
            font-size: 12px;
            width: auto;
            margin: 0;
        }

        .btn-delete-user:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .btn-export, .btn-import {
            background: #27ae60;
            padding: 10px;
            font-size: 14px;
            margin-top: 8px;
        }

        .btn-export:hover, .btn-import:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .section-divider {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .add-user-form {
            display: none;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .add-user-form.show {
            display: block;
        }

        .toggle-form-btn {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 15px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .toggle-form-btn:hover {
            background: #5568d3;
        }

        .no-users {
            text-align: center;
            color: #999;
            padding: 30px 0;
            font-size: 13px;
        }

        .users-stats {
            background: #f0f4ff;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            color: #667eea;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 15px;
        }

        #fileInput {
            display: none;
        }

        /* ==================== APP SCREEN ==================== */
        #appScreen {
            width: 100%;
        }

        #appScreen.hidden {
            display: none;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border: 1px solid white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }

        .nav-tabs button {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs button:hover {
            background: #f0f0f0;
            color: #667eea;
        }

        .nav-tabs button.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .content {
            padding: 30px;
            min-height: 400px;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header-user {
                flex-direction: column;
            }

            .login-wrapper {
                flex-direction: column;
                gap: 20px;
            }
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        label.required::after {
            content: " *";
            color: #e74c3c;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group,
        .radio-group {
            display: grid;
            gap: 12px;
            margin-top: 10px;
        }

        .checkbox-item,
        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"],
        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label,
        .radio-item label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .sub-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .sub-section-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            font-size: 14px;
        }

        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #ddd;
            font-size: 13px;
            color: #666;
        }

        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #27ae60;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-wrapper">
            <!-- LEFT: LOGIN FORM -->
            <div class="login-container">
                <div class="login-header">
                    <h1>üè• CSI</h1>
                    <p>Cartella Sociale Informatizzata<br><strong>ATS Insubria</strong></p>
                </div>

                <div id="loginAlert"></div>

                <form class="login-form" onsubmit="effettuaLogin(event)">
                    <div class="form-group">
                        <label for="username">üìß Email o Username</label>
                        <input type="text" id="username" placeholder="Inserisci la tua email" required>
                    </div>

                    <div class="form-group">
                        <label for="password">üîê Password</label>
                        <input type="password" id="password" placeholder="Inserisci la tua password" required>
                    </div>

                    <div class="remember-forgot">
                        <div>
                            <input type="checkbox" id="rememberMe" name="remember">
                            <label for="rememberMe">Ricordami</label>
                        </div>
                        <a class="forgot-password" onclick="passwordDimenticata()">Password dimenticata?</a>
                    </div>

                    <button type="submit" class="login-btn">üîì Accedi</button>
                </form>

                <div class="login-divider">oppure</div>

                <div class="guest-login">
                    <button type="button" class="guest-btn" onclick="accessoGuest()">üë• Ospite</button>
                </div>
            </div>

            <!-- RIGHT: USERS MANAGEMENT -->
            <div class="users-container">
                <div class="users-header">
                    <h2>üë• Utenti Disponibili</h2>
                </div>

                <div id="loginAlert2"></div>

                <button class="toggle-form-btn" onclick="toggleAddUserForm()">‚ûï Aggiungi Nuovo Utente</button>

                <div id="addUserForm" class="add-user-form">
                    <form onsubmit="aggiungiUtente(event)">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newEmail">üìß Email *</label>
                            <input type="email" id="newEmail" placeholder="user@example.com" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newPassword">üîê Password *</label>
                            <input type="password" id="newPassword" placeholder="Inserisci password" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newNome">üë§ Nome Completo *</label>
                            <input type="text" id="newNome" placeholder="Es: Mario Rossi" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newRuolo">üìã Ruolo *</label>
                            <select id="newRuolo" required>
                                <option value="">-- Selezionare --</option>
                                <option value="üîê Amministratore">üîê Amministratore</option>
                                <option value="üë®‚Äçüíº Supervisore">üë®‚Äçüíº Supervisore</option>
                                <option value="üè• Operatore Sanitario">üè• Operatore Sanitario</option>
                                <option value="üë§ Operatore Sociale">üë§ Operatore Sociale</option>
                                <option value="üë• Ospite">üë• Ospite</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newOrg">üè¢ Organizzazione *</label>
                            <input type="text" id="newOrg" placeholder="Es: ASST Sette Laghi" required>
                        </div>
                        <button type="submit" class="btn-add-user">‚úÖ Aggiungi Utente</button>
                        <button type="button" class="btn-add-user" style="background: #95a5a6; margin-top: 8px;" onclick="toggleAddUserForm()">‚ùå Annulla</button>
                    </form>
                </div>

                <div class="section-divider">
                    <div class="users-stats" id="usersStats">Utenti caricati: 0</div>
                </div>

                <div id="usersList"></div>

                <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
                    <button class="btn-export" onclick="esportaUtentiJSON()">üì• Esporta Utenti</button>
                    <button class="btn-import" onclick="document.getElementById('fileInput').click()">üì§ Importa Utenti</button>
                    <input type="file" id="fileInput" accept=".json" onchange="importaUtentiJSON(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="appScreen" class="hidden">
        <div class="container">
            <header>
                <h1>üè• Cartella Sociale Informatizzata</h1>
                <div class="header-user">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div>
                        <div id="userName" style="font-weight: 600;"></div>
                        <div id="userRole" style="font-size: 12px; opacity: 0.8;"></div>
                        <div id="userOrg" style="font-size: 11px; opacity: 0.7;"></div>
                    </div>
                    <button class="logout-btn" onclick="effettuaLogout()">Esci</button>
                </div>
            </header>

            <div class="nav-tabs" role="tablist">
                <button class="nav-tab active" data-tab="anagrafica" role="tab">1. Anagrafica</button>
                <button class="nav-tab" data-tab="interventi" role="tab">2. Interventi</button>
                <button class="nav-tab" data-tab="autosufficienza" role="tab">3. Autosufficienza</button>
                <button class="nav-tab" data-tab="abitativa" role="tab">4. Socio-Abitativa</button>
                <button class="nav-tab" data-tab="economica" role="tab">5. Socio-Economica</button>
                <button class="nav-tab" data-tab="familiare" role="tab">6. Socio-Familiare</button>
                <button class="nav-tab" data-tab="giuridica" role="tab">7. Giuridica</button>
            </div>

            <div class="content">
                <!-- TAB 1: ANAGRAFICA -->
                <div id="anagrafica" class="tab-pane active" role="tabpanel">
                    <div class="section-title">DATI ANAGRAFICI DEL PAZIENTE</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome" class="required">Nome e Cognome</label>
                            <input type="text" id="nome" class="required-field" placeholder="Es: Mario Rossi">
                        </div>
                        <div class="form-group">
                            <label for="luogo-nascita" class="required">Luogo di nascita</label>
                            <input type="text" id="luogo-nascita" class="required-field" placeholder="Es: Milano">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="data-nascita" class="required">Data di nascita</label>
                            <input type="date" id="data-nascita" class="required-field">
                        </div>
                        <div class="form-group">
                            <label for="stato-civile" class="required">Stato civile</label>
                            <select id="stato-civile" class="required-field">
                                <option value="">-- Selezionare --</option>
                                <option value="celibe">Celibe/Nubile</option>
                                <option value="coniugato">Coniugato/a</option>
                                <option value="convivente">Convivente</option>
                                <option value="vedovo">Vedovo/a</option>
                                <option value="separato">Separato/a</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cittadinanza" class="required">Cittadinanza</label>
                            <input type="text" id="cittadinanza" class="required-field" placeholder="Es: Italiana">
                        </div>
                        <div class="form-group">
                            <label for="codice-fiscale" class="required">Codice Fiscale</label>
                            <input type="text" id="codice-fiscale" class="required-field" placeholder="Es: RSSMRA80A01H501X">
                        </div>
                    </div>

                    <div class="sub-section">
                        <div class="sub-section-title">Contatti e Residenza</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="indirizzo-residenza">Indirizzo di residenza</label>
                                <input type="text" id="indirizzo-residenza" placeholder="Via, numero, citt√†">
                            </div>
                            <div class="form-group">
                                <label for="indirizzo-domicilio">Indirizzo di domicilio</label>
                                <input type="text" id="indirizzo-domicilio" placeholder="Se diverso da residenza">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="telefono">Telefono</label>
                                <input type="tel" id="telefono" placeholder="Es: 02 xxxx xxxx">
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" placeholder="Es: mario.rossi@email.com">
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="pulisciSezione('anagrafica')">Pulisci</button>
                        <button class="btn-primary" onclick="salvaSezione('anagrafica')">Salva Sezione</button>
                    </div>
                </div>

                <!-- TAB 2: INTERVENTI -->
                <div id="interventi" class="tab-pane" role="tabpanel">
                    <div class="section-title">INTERVENTI ATTIVI</div>

                    <div class="sub-section">
                        <div class="sub-section-title">Interventi Sanitari</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="adi-infermieristica" name="adi">
                                <label for="adi-infermieristica">ADI - Infermieristica</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adi-riabilitazione" name="adi">
                                <label for="adi-riabilitazione">ADI - Riabilitazione</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="adi-fisioterapia" name="adi">
                                <label for="adi-fisioterapia">ADI - Fisioterapia</label>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="pulisciSezione('interventi')">Pulisci</button>
                        <button class="btn-primary" onclick="salvaSezione('interventi')">Salva Sezione</button>
                    </div>
                </div>

                <!-- TAB 3: AUTOSUFFICIENZA -->
                <div id="autosufficienza" class="tab-pane" role="tabpanel">
                    <div class="section-title">INDICATORI DI AUTOSUFFICIENZA</div>

                    <div class="sub-section">
                        <div class="sub-section-title">Indici Funzionali</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="adl-punteggio">Indici funzionali - ADL (punteggio)</label>
                                <input type="number" id="adl-punteggio" min="0" max="30" placeholder="0-30">
                            </div>
                            <div class="form-group">
                                <label for="iadl-punteggio">Indici funzionali - IADL (punteggio)</label>
                                <input type="number" id="iadl-punteggio" min="0" max="8" placeholder="0-8">
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="pulisciSezione('autosufficienza')">Pulisci</button>
                        <button class="btn-primary" onclick="salvaSezione('autosufficienza')">Salva Sezione</button>
                    </div>
                </div>

                <!-- TAB 4: ABITATIVA -->
                <div id="abitativa" class="tab-pane" role="tabpanel">
                    <div class="section-title">CONDIZIONE SOCIO-ABITATIVA</div>

                    <div class="sub-section">
                        <div class="sub-section-title">Alloggio</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tipo-alloggio">Tipo di alloggio</label>
                                <select id="tipo-alloggio">
                                    <option value="">-- Selezionare --</option>
                                    <option value="propriet√†">Di propriet√†</option>
                                    <option value="affitto">In affitto / Comodato</option>
                                    <option value="pubblico">Alloggio pubblico</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="zona">Zona</label>
                                <select id="zona">
                                    <option value="">-- Selezionare --</option>
                                    <option value="urbana">Urbana</option>
                                    <option value="rurale">Rurale</option>
                                    <option value="montana">Montana</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="pulisciSezione('abitativa')">Pulisci</button>
                        <button class="btn-primary" onclick="salvaSezione('abitativa')">Salva Sezione</button>
                    </div>
                </div>

                <!-- TAB 5: ECONOMICA -->
                <div id="economica" class="tab-pane" role="tabpanel">
                    <div class="section-title">CONDIZIONE SOCIO-ECONOMICA</div>

                    <div class="sub-section">
                        <div class="sub-section-title">ISEE</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="valore-isee">Valore ISEE</label>
                                <input type="number" id="valore-isee" placeholder="Valore numerico">
                            </div>
                            <div class="form-group">
                                <label for="tipologia-isee">Tipologia ISEE</label>
                                <select id="tipologia-isee">
                                    <option value="">-- Selezionare --</option>
                                    <option value="ordinario">Ordinario</option>
                                    <option value="socio-sanitario">Socio-sanitario</option>
                                    <option value="minorenni">Minorenni</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="pulisciSezione('economica')">Pulisci</button>
                        <button class="btn-primary" onclick="salvaSezione('economica')">Salva Sezione</button>
                    </div>
                </div>

                <!-- TAB 6: FAMILIARE -->
                <div id="familiare" class="tab-pane" role="tabpanel">
                    <div class="section-title">CONDIZIONE SOCIO-FAMILIARE</div>

                    <div class="sub-section">
                        <div class="sub-section-title">Composizione Nucleo Familiare</div>
                        <div class="form-group">
                            <label>Composizione del nucleo</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="nucleo-solo" name="composizione-nucleo" value="solo">
                                    <label for="nucleo-solo">Da solo/a</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="nucleo-coniuge" name="composizione-nucleo" value="coniuge">
                                    <label for="nucleo-coniuge">In nucleo con coniuge/convivente</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="nucleo-familiari" name="composizione-nucleo" value="familiari">
                                    <label for="nucleo-familiari">In nucleo con propri familiari</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="pulisciSezione('familiare')">Pulisci</button>
                        <button class="btn-primary" onclick="salvaSezione('familiare')">Salva Sezione</button>
                    </div>
                </div>

                <!-- TAB 7: GIURIDICA -->
                <div id="giuridica" class="tab-pane" role="tabpanel">
                    <div class="section-title">PROTEZIONE GIURIDICA</div>

                    <div class="sub-section">
                        <div class="sub-section-title">Amministratore di Sostegno</div>
                        <div class="form-group">
                            <label>Amministratore di Sostegno presente</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="adis-si" name="amministratore-sostegno" value="si">
                                    <label for="adis-si">Si</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="adis-no" name="amministratore-sostegno" value="no">
                                    <label for="adis-no">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="nome-adis">Nome e Cognome (se presente)</label>
                            <input type="text" id="nome-adis" placeholder="Nome dell'amministratore">
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="pulisciSezione('giuridica')">Pulisci</button>
                        <button class="btn-primary" onclick="salvaSezione('giuridica')">Salva Sezione</button>
                    </div>
                </div>
            </div>

            <div class="button-group" style="padding: 20px 30px; border-top: 1px solid #ddd; background: #f8f9fa;">
                <button class="btn-success" onclick="salvaCartella()">üíæ Salva Cartella Completa</button>
                <button class="btn-primary" onclick="esportaJSON()">üì• Esporta JSON</button>
                <button class="btn-danger" onclick="pulisciTutto()">üóëÔ∏è Pulisci Tutto</button>
            </div>

            <footer>
                <p><span class="sync-indicator"></span>‚úì Sincronizzazione pronta</p>
            </footer>
        </div>
    </div>

    <script>
        // ==================== DATABASE ACCOUNT INIZIALE ====================
        let usersDB = {
            // AMMINISTRATORI
            'andrea@asst.it': {
                password: 'admin2025!',
                nome: 'Andrea Rossi',
                ruolo: 'üîê Amministratore',
                avatar: 'AR',
                organizzazione: 'ATS Insubria - Admin'
            },
            // SUPERVISORI
            'donatella@asst.it': {
                password: 'super2025!',
                nome: 'Donatella Bianchi',
                ruolo: 'üë®‚Äçüíº Supervisore',
                avatar: 'DB',
                organizzazione: 'ATS Insubria - Supervisione'
            },
            // DEMO
            'demo@asst.it': {
                password: 'demo123',
                nome: 'Account Demo',
                ruolo: 'üë§ Demo User',
                avatar: 'DM',
                organizzazione: 'ATS Insubria - Demo'
            },
            // ASST SETTE LAGHI (VARESE)
            'operatore.asst1@asst.it': {
                password: 'asst1@2025',
                nome: 'Operatore ASST Sette Laghi',
                ruolo: 'üè• Operatore Sanitario',
                avatar: 'AS1',
                organizzazione: 'ASST Sette Laghi - Varese'
            },
            // ASST VALLE OLONA (BUSTO ARSIZIO)
            'operatore.asst2@asst.it': {
                password: 'asst2@2025',
                nome: 'Operatore ASST Valle Olona',
                ruolo: 'üè• Operatore Sanitario',
                avatar: 'AS2',
                organizzazione: 'ASST Valle Olona - Busto Arsizio'
            },
            // ASST LARIANA (COMO)
            'operatore.asst3@asst.it': {
                password: 'asst3@2025',
                nome: 'Operatore ASST Lariana',
                ruolo: 'üè• Operatore Sanitario',
                avatar: 'AS3',
                organizzazione: 'ASST Lariana - Como'
            },
            
            // AMBITI SETTE LAGHI
            'operatore.arcisate@ambiti.it': {
                password: 'arcisate@2025',
                nome: 'Operatore Ambito Arcisate',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OA',
                organizzazione: 'Ambito Sette Laghi - Arcisate'
            },
            'operatore.azzate@ambiti.it': {
                password: 'azzate@2025',
                nome: 'Operatore Ambito Azzate',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OZ',
                organizzazione: 'Ambito Sette Laghi - Azzate'
            },
            'operatore.laveno@ambiti.it': {
                password: 'laveno@2025',
                nome: 'Operatore Ambito Laveno Mombello',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OL',
                organizzazione: 'Ambito Sette Laghi - Laveno Mombello'
            },
            'operatore.luino@ambiti.it': {
                password: 'luino@2025',
                nome: 'Operatore Ambito Luino',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OU',
                organizzazione: 'Ambito Sette Laghi - Luino'
            },
            'operatore.sesto@ambiti.it': {
                password: 'sesto@2025',
                nome: 'Operatore Ambito Sesto Calende',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OS',
                organizzazione: 'Ambito Sette Laghi - Sesto Calende'
            },
            'operatore.tradate@ambiti.it': {
                password: 'tradate@2025',
                nome: 'Operatore Ambito Tradate',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OT',
                organizzazione: 'Ambito Sette Laghi - Tradate'
            },
            'operatore.varese@ambiti.it': {
                password: 'varese@2025',
                nome: 'Operatore Ambito Varese',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OV',
                organizzazione: 'Ambito Sette Laghi - Varese'
            },

            // AMBITI VALLE OLONA
            'operatore.busto@ambiti.it': {
                password: 'busto@2025',
                nome: 'Operatore Ambito Busto Arsizio',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OB',
                organizzazione: 'Ambito Valle Olona - Busto Arsizio - Castellanza'
            },
            'operatore.gallarate@ambiti.it': {
                password: 'gallarate@2025',
                nome: 'Operatore Ambito Gallarate',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OG',
                organizzazione: 'Ambito Valle Olona - Gallarate'
            },
            'operatore.saronno@ambiti.it': {
                password: 'saronno@2025',
                nome: 'Operatore Ambito Saronno',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OR',
                organizzazione: 'Ambito Valle Olona - Saronno'
            },
            'operatore.somma@ambiti.it': {
                password: 'somma@2025',
                nome: 'Operatore Ambito Somma Lombardo',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OX',
                organizzazione: 'Ambito Valle Olona - Somma Lombardo'
            },

            // AMBITI LARIANA
            'operatore.cantu@ambiti.it': {
                password: 'cantu@2025',
                nome: 'Operatore Ambito Cant√π',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OC',
                organizzazione: 'Ambito Lariana - Cant√π - Mariano Comense'
            },
            'operatore.como@ambiti.it': {
                password: 'como@2025',
                nome: 'Operatore Ambito Como',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OD',
                organizzazione: 'Ambito Lariana - Como - Campione d\'Italia'
            },
            'operatore.erba@ambiti.it': {
                password: 'erba@2025',
                nome: 'Operatore Ambito Erba',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OE',
                organizzazione: 'Ambito Lariana - Erba'
            },
            'operatore.lomazzo@ambiti.it': {
                password: 'lomazzo@2025',
                nome: 'Operatore Ambito Lomazzo',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OW',
                organizzazione: 'Ambito Lariana - Lomazzo - Fino Mornasco'
            },
            'operatore.mediolario@ambiti.it': {
                password: 'mediolario@2025',
                nome: 'Operatore Ambito Medio Lario',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OM',
                organizzazione: 'Ambito Lariana - Medio Lario'
            },
            'operatore.olgiate@ambiti.it': {
                password: 'olgiate@2025',
                nome: 'Operatore Ambito Olgiate Comasco',
                ruolo: 'üë§ Operatore Sociale',
                avatar: 'OI',
                organizzazione: 'Ambito Lariana - Olgiate Comasco'
            },

            // ACCOUNT OSPITE
            'ospite': {
                password: 'guest',
                nome: 'Ospite',
                ruolo: 'üë• Accesso Ospite',
                avatar: 'OS',
                organizzazione: 'Accesso Limitato'
            }
        };

        // Carica utenti salvati da localStorage
        function caricaUtentiDaSalvataggio() {
            const utentiSalvati = localStorage.getItem('usersDB');
            if (utentiSalvati) {
                usersDB = JSON.parse(utentiSalvati);
            }
        }

        // Salva utenti in localStorage
        function salvaUtentiInLocalStorage() {
            localStorage.setItem('usersDB', JSON.stringify(usersDB));
        }

        // Aggiorna lista utenti visibili
        function aggiornaListaUtenti() {
            const usersList = document.getElementById('usersList');
            const usersStats = document.getElementById('usersStats');
            const utenti = Object.keys(usersDB);

            if (utenti.length === 0) {
                usersList.innerHTML = '<div class="no-users">Nessun utente inserito</div>';
            } else {
                usersList.innerHTML = utenti.map(email => {
                    const utente = usersDB[email];
                    return `
                        <div class="user-item">
                            <div class="user-info" onclick="usaUtenteLogin('${email}')">
                                <div class="user-email">${email}</div>
                                <div class="user-role">${utente.ruolo}</div>
                                <div class="user-org">${utente.organizzazione}</div>
                            </div>
                            <button class="btn-delete-user" onclick="eliminaUtente('${email}')">üóëÔ∏è Elimina</button>
                        </div>
                    `;
                }).join('');
            }

            usersStats.textContent = `Utenti caricati: ${utenti.length}`;
        }

        function toggleAddUserForm() {
            const form = document.getElementById('addUserForm');
            form.classList.toggle('show');
        }

        function aggiungiUtente(event) {
            event.preventDefault();
            const email = document.getElementById('newEmail').value.toLowerCase();
            const password = document.getElementById('newPassword').value;
            const nome = document.getElementById('newNome').value;
            const ruolo = document.getElementById('newRuolo').value;
            const organizzazione = document.getElementById('newOrg').value;

            if (usersDB[email]) {
                mostraAlertLogin2('‚ùå Email gi√† presente nel sistema!', 'error');
                return;
            }

            const avatar = nome.split(' ').map(p => p[0]).join('').toUpperCase().slice(0, 2);

            usersDB[email] = {
                password: password,
                nome: nome,
                ruolo: ruolo,
                avatar: avatar,
                organizzazione: organizzazione
            };

            salvaUtentiInLocalStorage();
            aggiornaListaUtenti();
            
            // Pulisci form
            document.getElementById('newEmail').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newNome').value = '';
            document.getElementById('newRuolo').value = '';
            document.getElementById('newOrg').value = '';
            
            toggleAddUserForm();
            mostraAlertLogin2(`‚úÖ Utente "${nome}" aggiunto con successo!`, 'success');
        }

        function eliminaUtente(email) {
            if (confirm(`Sei sicuro di voler eliminare l'utente ${email}?`)) {
                delete usersDB[email];
                salvaUtentiInLocalStorage();
                aggiornaListaUtenti();
                mostraAlertLogin2('‚úÖ Utente eliminato!', 'success');
            }
        }

        function esportaUtentiJSON() {
            const dataStr = JSON.stringify(usersDB, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `CSI_Utenti_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            mostraAlertLogin2('‚úÖ Utenti esportati in JSON!', 'success');
        }

        function importaUtentiJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedUsers = JSON.parse(e.target.result);
                    usersDB = { ...usersDB, ...importedUsers };
                    salvaUtentiInLocalStorage();
                    aggiornaListaUtenti();
                    mostraAlertLogin2(`‚úÖ Importati ${Object.keys(importedUsers).length} utenti!`, 'success');
                    document.getElementById('fileInput').value = '';
                } catch (error) {
                    mostraAlertLogin2('‚ùå Errore nell\'importazione del file JSON!', 'error');
                }
            };
            reader.readAsText(file);
        }

        function usaUtenteLogin(email) {
            document.getElementById('username').value = email;
            document.getElementById('password').focus();
        }

        function effettuaLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            const utente = usersDB[username];

            if (!utente) {
                mostraAlertLogin('‚ùå Email/Username non trovato!', 'error');
                return;
            }

            if (utente.password !== password) {
                mostraAlertLogin('‚ùå Password non corretta!', 'error');
                return;
            }

            // Login riuscito
            if (rememberMe) {
                localStorage.setItem('usuarioRicordato', username);
            }

            localStorage.setItem('usuarioLoggato', JSON.stringify({
                username: username,
                nome: utente.nome,
                ruolo: utente.ruolo,
                avatar: utente.avatar,
                organizzazione: utente.organizzazione,
                loginTime: new Date().toLocaleString('it-IT')
            }));

            mostraAlertLogin(`‚úÖ Benvenuto ${utente.nome}!`, 'success');
            setTimeout(() => {
                mostraApp();
            }, 800);
        }

        function accessoGuest() {
            localStorage.setItem('usuarioLoggato', JSON.stringify({
                username: 'ospite',
                nome: 'Ospite',
                ruolo: 'üë• Accesso Ospite',
                avatar: 'OS',
                organizzazione: 'Accesso Limitato',
                loginTime: new Date().toLocaleString('it-IT')
            }));
            mostraApp();
        }

        function passwordDimenticata() {
            alert('üîê Password dimenticata?\n\nContatta l\'amministratore:\nandrea@asst.it\n\nAccount nel sistema per il test.');
        }

        function mostraAlertLogin(messaggio, tipo) {
            const alertDiv = document.getElementById('loginAlert');
            alertDiv.innerHTML = `<div class="alert alert-${tipo}">${messaggio}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function mostraAlertLogin2(messaggio, tipo) {
            const alertDiv = document.getElementById('loginAlert2');
            alertDiv.innerHTML = `<div class="alert alert-${tipo}">${messaggio}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function mostraApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');

            const utente = JSON.parse(localStorage.getItem('usuarioLoggato'));
            document.getElementById('userName').textContent = utente.nome;
            document.getElementById('userRole').textContent = utente.ruolo;
            document.getElementById('userOrg').textContent = utente.organizzazione;
            document.getElementById('userAvatar').textContent = utente.avatar;
        }

        function effettuaLogout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                localStorage.removeItem('usuarioLoggato');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginAlert').innerHTML = '';
                document.getElementById('addUserForm').classList.remove('show');
            }
        }

        // ==================== GESTIONE TAB ====================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                mostraTab(tabName);
            });
        });

        function mostraTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            window.scrollTo(0, 0);
        }

        // ==================== GESTIONE DATI ====================
        function salvaSezione(sezione) {
            const dati = raccogliDatiSezione(sezione);
            localStorage.setItem(`csi_${sezione}`, JSON.stringify(dati, null, 2));
            mostraAlert(`‚úÖ Sezione "${sezione}" salvata!`, 'success');
        }

        function raccogliDatiSezione(sezione) {
            const dati = {};
            const inputs = document.getElementById(sezione).querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    dati[input.id] = input.checked;
                } else {
                    dati[input.id] = input.value;
                }
            });
            return dati;
        }

        function pulisciSezione(sezione) {
            if (confirm(`Sei sicuro di voler pulire la sezione "${sezione}"?`)) {
                const inputs = document.getElementById(sezione).querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                mostraAlert(`‚úÖ Sezione "${sezione}" pulita!`, 'success');
            }
        }

        function salvaCartella() {
            const cartella = {};
            ['anagrafica', 'interventi', 'autosufficienza', 'abitativa', 'economica', 'familiare', 'giuridica'].forEach(sezione => {
                cartella[sezione] = raccogliDatiSezione(sezione);
            });
            localStorage.setItem('csi_completa', JSON.stringify(cartella, null, 2));
            mostraAlert('‚úÖ Cartella Completa salvata!', 'success');
        }

        function esportaJSON() {
            const cartella = {};
            ['anagrafica', 'interventi', 'autosufficienza', 'abitativa', 'economica', 'familiare', 'giuridica'].forEach(sezione => {
                cartella[sezione] = raccogliDatiSezione(sezione);
            });

            const dataStr = JSON.stringify(cartella, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `CSI_${new Date().getTime()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            mostraAlert('‚úÖ Cartella esportata in JSON!', 'success');
        }

        function pulisciTutto() {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Questa azione eliminer√† TUTTI i dati salvati. Sei sicuro?')) {
                localStorage.removeItem('csi_completa');
                ['anagrafica', 'interventi', 'autosufficienza', 'abitativa', 'economica', 'familiare', 'giuridica'].forEach(sezione => {
                    localStorage.removeItem(`csi_${sezione}`);
                });
                location.reload();
            }
        }

        function mostraAlert(messaggio, tipo) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo}`;
            alert.textContent = messaggio;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.maxWidth = '400px';
            document.body.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 4000);
        }

        // ==================== INIT ====================
        window.addEventListener('load', function() {
            caricaUtentiDaSalvataggio();
            aggiornaListaUtenti();

            const utente = localStorage.getItem('usuarioLoggato');
            const usuarioRicordato = localStorage.getItem('usuarioRicordato');

            if (utente) {
                mostraApp();
            } else if (usuarioRicordato) {
                document.getElementById('username').value = usuarioRicordato;
                document.getElementById('password').focus();
            }
        });
    </script>
</body>
</html>