<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• CSI - Sistema di Autenticazione ATS Insubria</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ==================== LOGIN SCREEN ==================== */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            flex-direction: column;
            gap: 20px;
        }

        #loginScreen.hidden {
            display: none;
        }

        .login-wrapper {
            display: flex;
            gap: 20px;
            max-width: 900px;
            width: 100%;
            flex-wrap: wrap;
            justify-content: center;
        }

        .login-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            animation: slideIn 0.5s ease;
        }

        .users-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            padding: 40px;
            animation: slideIn 0.5s ease;
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }

        .users-container.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .users-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
        }

        .users-header h2 {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .remember-forgot input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .remember-forgot label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: #333;
        }

        .forgot-password {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .login-divider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            color: #999;
            font-size: 13px;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
        }

        .guest-login {
            display: flex;
            gap: 10px;
        }

        .guest-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .guest-btn:hover {
            background: #f5f7ff;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .user-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        .user-info {
            flex: 1;
            cursor: pointer;
            padding: 8px;
        }

        .user-email {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .user-role {
            color: #666;
            font-size: 12px;
            margin-top: 2px;
        }

        .user-org {
            color: #999;
            font-size: 11px;
            margin-top: 2px;
        }

        .btn-delete-user {
            background: #e74c3c;
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-delete-user:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .btn-export, .btn-import {
            background: #27ae60;
            color: white;
            padding: 10px;
            font-size: 14px;
            margin-top: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-export:hover, .btn-import:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .toggle-form-btn {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 15px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .toggle-form-btn:hover {
            background: #5568d3;
        }

        .add-user-form {
            display: none;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .add-user-form.show {
            display: block;
        }

        #fileInput {
            display: none;
        }

        /* ==================== APP SCREEN ==================== */
        #appScreen {
            width: 100%;
        }

        #appScreen.hidden {
            display: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border: 1px solid white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .admin-panel {
            background: #fff3cd;
            padding: 20px;
            border-bottom: 2px solid #ffc107;
            display: none;
        }

        .admin-panel.show {
            display: block;
        }

        .admin-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .admin-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .admin-btn {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .tabs-container {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            gap: 0;
        }

        .tab-button {
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            flex: 1;
            min-width: 150px;
        }

        .tab-button:hover {
            background: #f0f0f0;
            color: #667eea;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .content {
            padding: 30px;
            min-height: 400px;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .person-selector {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }

        .person-selector-title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .person-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .person-btn {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 6px;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .person-btn:hover {
            background: #f5f7ff;
        }

        .person-btn.active {
            background: #667eea;
            color: white;
        }

        .person-form-title {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        @media (max-width: 1024px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                text-align: center;
            }

            .header-user {
                flex-direction: column;
                width: 100%;
            }
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        label.required::after {
            content: " *";
            color: #e74c3c;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group,
        .radio-group {
            display: grid;
            gap: 12px;
            margin-top: 10px;
        }

        .checkbox-item,
        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"],
        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label,
        .radio-item label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .sub-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .sub-section-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .records-list {
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }

        .record-item {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .record-item:hover {
            background: #f5f7ff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .record-info {
            flex: 1;
        }

        .record-name {
            font-weight: 700;
            color: #333;
            font-size: 15px;
            margin-bottom: 5px;
        }

        .record-details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .record-buttons {
            display: flex;
            gap: 8px;
            margin-left: 15px;
        }

        .record-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .record-btn-view {
            background: #3498db;
            color: white;
        }

        .record-btn-view:hover {
            background: #2980b9;
        }

        .record-btn-edit {
            background: #f39c12;
            color: white;
        }

        .record-btn-edit:hover {
            background: #e67e22;
        }

        .record-btn-delete {
            background: #e74c3c;
            color: white;
        }

        .record-btn-delete:hover {
            background: #c0392b;
        }

        .no-records {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .record-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .record-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #ddd;
            font-size: 13px;
            color: #666;
        }

        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #27ae60;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .no-permission {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 16px;
        }

        .no-permission-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-wrapper">
            <!-- LOGIN FORM -->
            <div class="login-container">
                <div class="login-header">
                    <h1>üè• CSI</h1>
                    <p>Cartella Sociale Informatizzata<br><strong>ATS Insubria</strong></p>
                </div>

                <div id="loginAlert"></div>

                <form class="login-form" onsubmit="effettuaLogin(event)">
                    <div class="form-group">
                        <label for="username">üìß Email o Username</label>
                        <input type="text" id="username" placeholder="Inserisci la tua email" required>
                    </div>

                    <div class="form-group">
                        <label for="password">üîê Password</label>
                        <input type="password" id="password" placeholder="Inserisci la tua password" required>
                    </div>

                    <div class="remember-forgot">
                        <div>
                            <input type="checkbox" id="rememberMe" name="remember">
                            <label for="rememberMe">Ricordami</label>
                        </div>
                        <a class="forgot-password" onclick="passwordDimenticata()">Password dimenticata?</a>
                    </div>

                    <button type="submit" class="login-btn">üîì Accedi</button>
                </form>

                <div class="login-divider">oppure</div>

                <div class="guest-login">
                    <button type="button" class="guest-btn" onclick="accessoGuest()">üë• Ospite</button>
                </div>
            </div>

            <!-- USERS MANAGEMENT (ADMIN ONLY) -->
            <div class="users-container" id="usersContainer">
                <div class="users-header">
                    <h2>üë• Utenti Disponibili</h2>
                </div>

                <div id="loginAlert2"></div>

                <button class="toggle-form-btn" onclick="toggleAddUserForm()">‚ûï Aggiungi Nuovo Utente</button>

                <div id="addUserForm" class="add-user-form">
                    <form onsubmit="aggiungiUtente(event)">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newEmail">üìß Email *</label>
                            <input type="email" id="newEmail" placeholder="user@example.com" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newPassword">üîê Password *</label>
                            <input type="password" id="newPassword" placeholder="Inserisci password" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newNome">üë§ Nome Completo *</label>
                            <input type="text" id="newNome" placeholder="Es: Mario Rossi" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newRuolo">üìã Ruolo *</label>
                            <select id="newRuolo" required>
                                <option value="">-- Selezionare --</option>
                                <option value="üîê Amministratore">üîê Amministratore</option>
                                <option value="üë®‚Äçüíº Supervisore">üë®‚Äçüíº Supervisore</option>
                                <option value="üè• Operatore Sanitario">üè• Operatore Sanitario</option>
                                <option value="üë§ Operatore Sociale">üë§ Operatore Sociale</option>
                                <option value="üë• Ospite">üë• Ospite</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label for="newOrg">üè¢ Organizzazione *</label>
                            <input type="text" id="newOrg" placeholder="Es: ASST Sette Laghi" required>
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">‚úÖ Aggiungi Utente</button>
                        <button type="button" class="btn-secondary" style="width: 100%; margin-top: 8px;" onclick="toggleAddUserForm()">‚ùå Annulla</button>
                    </form>
                </div>

                <div id="usersList"></div>

                <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
                    <button class="btn-export" onclick="esportaUtentiJSON()">üì• Esporta Utenti</button>
                    <button class="btn-import" onclick="document.getElementById('fileInput').click()">üì§ Importa Utenti</button>
                    <input type="file" id="fileInput" accept=".json" onchange="importaUtentiJSON(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="appScreen" class="hidden">
        <div class="container">
            <header>
                <h1>üè• Cartella Sociale Informatizzata</h1>
                <div class="header-user">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div>
                        <div id="userName" style="font-weight: 600;"></div>
                        <div id="userRole" style="font-size: 12px; opacity: 0.8;"></div>
                        <div id="userOrg" style="font-size: 11px; opacity: 0.7;"></div>
                    </div>
                    <button class="logout-btn" onclick="effettuaLogout()">Esci</button>
                </div>
            </header>

            <!-- ADMIN PANEL -->
            <div class="admin-panel" id="adminPanel">
                <div class="admin-title">üîê Pannello Amministrazione</div>
                <div class="admin-buttons">
                    <button class="admin-btn" onclick="toggleUsersManagement()">üë• Gestisci Utenti</button>
                    <button class="admin-btn" onclick="esportaRilevamenti()">üì• Esporta Dati</button>
                    <button class="admin-btn" onclick="importaRilevamenti()">üì§ Importa Dati</button>
                </div>
            </div>

            <!-- USERS MANAGEMENT MODAL -->
            <div class="record-modal" id="usersModal">
                <div class="modal-content">
                    <div class="modal-header">
                        üë• Gestisci Utenti
                        <button class="modal-close" onclick="toggleUsersManagement()">√ó</button>
                    </div>
                    <div id="adminUsersList"></div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-primary" style="flex: 1;" onclick="toggleAddUserFormAdmin()">‚ûï Aggiungi Utente</button>
                        <button class="btn-secondary" style="flex: 1;" onclick="toggleUsersManagement()">Chiudi</button>
                    </div>
                    <div id="addUserFormAdmin" class="add-user-form" style="margin-top: 20px;">
                        <form onsubmit="aggiungiUtenteAdmin(event)">
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="adminNewEmail">üìß Email *</label>
                                <input type="email" id="adminNewEmail" placeholder="user@example.com" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="adminNewPassword">üîê Password *</label>
                                <input type="password" id="adminNewPassword" placeholder="Inserisci password" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="adminNewNome">üë§ Nome Completo *</label>
                                <input type="text" id="adminNewNome" placeholder="Es: Mario Rossi" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="adminNewRuolo">üìã Ruolo *</label>
                                <select id="adminNewRuolo" required>
                                    <option value="">-- Selezionare --</option>
                                    <option value="üîê Amministratore">üîê Amministratore</option>
                                    <option value="üë®‚Äçüíº Supervisore">üë®‚Äçüíº Supervisore</option>
                                    <option value="üè• Operatore Sanitario">üè• Operatore Sanitario</option>
                                    <option value="üë§ Operatore Sociale">üë§ Operatore Sociale</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="adminNewOrg">üè¢ Organizzazione *</label>
                                <input type="text" id="adminNewOrg" placeholder="Es: ASST Sette Laghi" required>
                            </div>
                            <button type="submit" class="btn-success" style="width: 100%;">‚úÖ Aggiungi</button>
                            <button type="button" class="btn-secondary" style="width: 100%; margin-top: 8px;" onclick="toggleAddUserFormAdmin()">‚ùå Annulla</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- IMPORT FILE INPUT -->
            <input type="file" id="fileInputApp" accept=".json" onchange="importaRilevamentiFile(event)" style="display: none;">

            <!-- TABS -->
            <div class="tabs-container">
                <button class="tab-button active" onclick="switchTab('rilevamenti')">üìã Rilevamenti</button>
                <button class="tab-button" onclick="switchTab('lista')">üë• Lista Persone</button>
            </div>

            <div class="content">
                <!-- TAB 1: RILEVAMENTI -->
                <div id="rilevamenti" class="tab-pane active">
                    <!-- PERSON SELECTOR -->
                    <div class="person-selector">
                        <div class="person-selector-title">üë§ Seleziona Persona per il Rilevamento</div>
                        <div class="person-buttons" id="personButtons"></div>
                        <button class="person-btn" style="background: #27ae60; color: white; margin-top: 12px;" onclick="mostraFormNuovaPersona()">‚ûï Nuova Persona</button>
                    </div>

                    <!-- FORM NUOVA PERSONA (HIDDEN) -->
                    <div id="nuovaPersonaForm" style="display: none; background: #f0f4ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div class="person-form-title">‚ûï Aggiungi Nuova Persona</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newPersonaNome" class="required">Nome e Cognome</label>
                                <input type="text" id="newPersonaNome" placeholder="Es: Mario Rossi" required>
                            </div>
                            <div class="form-group">
                                <label for="newPersonaCF" class="required">Codice Fiscale</label>
                                <input type="text" id="newPersonaCF" placeholder="Es: RSSMRA80A01H501X" required>
                            </div>
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn-success" onclick="creaPersona()">‚úÖ Crea Persona</button>
                            <button type="button" class="btn-secondary" onclick="nascondiFormNuovaPersona()">‚ùå Annulla</button>
                        </div>
                    </div>

                    <!-- FORM DATI ANAGRAFICI -->
                    <div id="formAnagrafica">
                        <div class="section-title">DATI ANAGRAFICI DEL PAZIENTE</div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="nome" class="required">Nome e Cognome</label>
                                <input type="text" id="nome" class="required-field" placeholder="Es: Mario Rossi" readonly>
                            </div>
                            <div class="form-group">
                                <label for="luogo-nascita">Luogo di nascita</label>
                                <input type="text" id="luogo-nascita" placeholder="Es: Milano">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="data-nascita">Data di nascita</label>
                                <input type="date" id="data-nascita">
                            </div>
                            <div class="form-group">
                                <label for="stato-civile">Stato civile</label>
                                <select id="stato-civile">
                                    <option value="">-- Selezionare --</option>
                                    <option value="celibe">Celibe/Nubile</option>
                                    <option value="coniugato">Coniugato/a</option>
                                    <option value="convivente">Convivente</option>
                                    <option value="vedovo">Vedovo/a</option>
                                    <option value="separato">Separato/a</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="cittadinanza">Cittadinanza</label>
                                <input type="text" id="cittadinanza" placeholder="Es: Italiana">
                            </div>
                            <div class="form-group">
                                <label for="codice-fiscale">Codice Fiscale</label>
                                <input type="text" id="codice-fiscale" placeholder="Es: RSSMRA80A01H501X" readonly>
                            </div>
                        </div>

                        <div class="sub-section">
                            <div class="sub-section-title">Contatti e Residenza</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="indirizzo-residenza">Indirizzo di residenza</label>
                                    <input type="text" id="indirizzo-residenza" placeholder="Via, numero, citt√†">
                                </div>
                                <div class="form-group">
                                    <label for="indirizzo-domicilio">Indirizzo di domicilio</label>
                                    <input type="text" id="indirizzo-domicilio" placeholder="Se diverso da residenza">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="telefono">Telefono</label>
                                    <input type="tel" id="telefono" placeholder="Es: 02 xxxx xxxx">
                                </div>
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" placeholder="Es: mario.rossi@email.com">
                                </div>
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="btn-secondary" onclick="pulisciSezione('anagrafica')">Pulisci</button>
                            <button class="btn-primary" onclick="salvaPersona()">üíæ Salva Persona</button>
                            <button class="btn-success" onclick="prossimaPersona()">‚û°Ô∏è Prossima Persona</button>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: LISTA PERSONE -->
                <div id="lista" class="tab-pane">
                    <div class="person-form-title">üë• Persone Rilevate</div>
                    <div class="records-list" id="personList"></div>
                </div>
            </div>

            <footer>
                <p><span class="sync-indicator"></span>‚úì Sincronizzazione pronta</p>
            </footer>
        </div>

        <!-- MODAL VISUALIZZAZIONE RECORD -->
        <div class="record-modal" id="viewModal">
            <div class="modal-content">
                <div class="modal-header">
                    üìã Dettagli Persona
                    <button class="modal-close" onclick="closeViewModal()">√ó</button>
                </div>
                <div id="viewModalContent"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATABASE ====================
        let usersDB = {
            'andrea@asst.it': { password: 'admin2025!', nome: 'Andrea Rossi', ruolo: 'üîê Amministratore', avatar: 'AR', organizzazione: 'ATS Insubria - Admin' },
            'donatella@asst.it': { password: 'super2025!', nome: 'Donatella Bianchi', ruolo: 'üë®‚Äçüíº Supervisore', avatar: 'DB', organizzazione: 'ATS Insubria - Supervisione' },
            'demo@asst.it': { password: 'demo123', nome: 'Account Demo', ruolo: 'üë§ Demo User', avatar: 'DM', organizzazione: 'ATS Insubria - Demo' },
            'operatore.asst1@asst.it': { password: 'asst1@2025', nome: 'Operatore ASST Sette Laghi', ruolo: 'üè• Operatore Sanitario', avatar: 'AS1', organizzazione: 'ASST Sette Laghi - Varese' },
            'operatore.asst2@asst.it': { password: 'asst2@2025', nome: 'Operatore ASST Valle Olona', ruolo: 'üè• Operatore Sanitario', avatar: 'AS2', organizzazione: 'ASST Valle Olona - Busto Arsizio' },
            'operatore.asst3@asst.it': { password: 'asst3@2025', nome: 'Operatore ASST Lariana', ruolo: 'üè• Operatore Sanitario', avatar: 'AS3', organizzazione: 'ASST Lariana - Como' },
            'operatore.arcisate@ambiti.it': { password: 'arcisate@2025', nome: 'Operatore Ambito Arcisate', ruolo: 'üë§ Operatore Sociale', avatar: 'OA', organizzazione: 'Ambito Sette Laghi - Arcisate' },
            'operatore.azzate@ambiti.it': { password: 'azzate@2025', nome: 'Operatore Ambito Azzate', ruolo: 'üë§ Operatore Sociale', avatar: 'OZ', organizzazione: 'Ambito Sette Laghi - Azzate' },
            'operatore.laveno@ambiti.it': { password: 'laveno@2025', nome: 'Operatore Ambito Laveno Mombello', ruolo: 'üë§ Operatore Sociale', avatar: 'OL', organizzazione: 'Ambito Sette Laghi - Laveno Mombello' },
            'operatore.luino@ambiti.it': { password: 'luino@2025', nome: 'Operatore Ambito Luino', ruolo: 'üë§ Operatore Sociale', avatar: 'OU', organizzazione: 'Ambito Sette Laghi - Luino' },
            'operatore.sesto@ambiti.it': { password: 'sesto@2025', nome: 'Operatore Ambito Sesto Calende', ruolo: 'üë§ Operatore Sociale', avatar: 'OS', organizzazione: 'Ambito Sette Laghi - Sesto Calende' },
            'operatore.tradate@ambiti.it': { password: 'tradate@2025', nome: 'Operatore Ambito Tradate', ruolo: 'üë§ Operatore Sociale', avatar: 'OT', organizzazione: 'Ambito Sette Laghi - Tradate' },
            'operatore.varese@ambiti.it': { password: 'varese@2025', nome: 'Operatore Ambito Varese', ruolo: 'üë§ Operatore Sociale', avatar: 'OV', organizzazione: 'Ambito Sette Laghi - Varese' },
            'operatore.busto@ambiti.it': { password: 'busto@2025', nome: 'Operatore Ambito Busto Arsizio', ruolo: 'üë§ Operatore Sociale', avatar: 'OB', organizzazione: 'Ambito Valle Olona - Busto Arsizio - Castellanza' },
            'operatore.gallarate@ambiti.it': { password: 'gallarate@2025', nome: 'Operatore Ambito Gallarate', ruolo: 'üë§ Operatore Sociale', avatar: 'OG', organizzazione: 'Ambito Valle Olona - Gallarate' },
            'operatore.saronno@ambiti.it': { password: 'saronno@2025', nome: 'Operatore Ambito Saronno', ruolo: 'üë§ Operatore Sociale', avatar: 'OR', organizzazione: 'Ambito Valle Olona - Saronno' },
            'operatore.somma@ambiti.it': { password: 'somma@2025', nome: 'Operatore Ambito Somma Lombardo', ruolo: 'üë§ Operatore Sociale', avatar: 'OX', organizzazione: 'Ambito Valle Olona - Somma Lombardo' },
            'operatore.cantu@ambiti.it': { password: 'cantu@2025', nome: 'Operatore Ambito Cant√π', ruolo: 'üë§ Operatore Sociale', avatar: 'OC', organizzazione: 'Ambito Lariana - Cant√π - Mariano Comense' },
            'operatore.como@ambiti.it': { password: 'como@2025', nome: 'Operatore Ambito Como', ruolo: 'üë§ Operatore Sociale', avatar: 'OD', organizzazione: 'Ambito Lariana - Como - Campione d\'Italia' },
            'operatore.erba@ambiti.it': { password: 'erba@2025', nome: 'Operatore Ambito Erba', ruolo: 'üë§ Operatore Sociale', avatar: 'OE', organizzazione: 'Ambito Lariana - Erba' },
            'operatore.lomazzo@ambiti.it': { password: 'lomazzo@2025', nome: 'Operatore Ambito Lomazzo', ruolo: 'üë§ Operatore Sociale', avatar: 'OW', organizzazione: 'Ambito Lariana - Lomazzo - Fino Mornasco' },
            'operatore.mediolario@ambiti.it': { password: 'mediolario@2025', nome: 'Operatore Ambito Medio Lario', ruolo: 'üë§ Operatore Sociale', avatar: 'OM', organizzazione: 'Ambito Lariana - Medio Lario' },
            'operatore.olgiate@ambiti.it': { password: 'olgiate@2025', nome: 'Operatore Ambito Olgiate Comasco', ruolo: 'üë§ Operatore Sociale', avatar: 'OI', organizzazione: 'Ambito Lariana - Olgiate Comasco' },
            'ospite': { password: 'guest', nome: 'Ospite', ruolo: 'üë• Accesso Ospite', avatar: 'OS', organizzazione: 'Accesso Limitato' }
        };

        let personeRilevate = {};
        let currentPersonaId = null;
        let currentUserLoggato = null;

        // Carica da localStorage
        function caricaDati() {
            const usersDB_saved = localStorage.getItem('usersDB');
            if (usersDB_saved) usersDB = JSON.parse(usersDB_saved);

            const persone_saved = localStorage.getItem('personeRilevate');
            if (persone_saved) personeRilevate = JSON.parse(persone_saved);
        }

        function salvaInLocalStorage() {
            localStorage.setItem('usersDB', JSON.stringify(usersDB));
            localStorage.setItem('personeRilevate', JSON.stringify(personeRilevate));
        }

        function aggiornaListaUtentiLogin() {
            const usersList = document.getElementById('usersList');
            const utenti = Object.keys(usersDB);

            if (utenti.length === 0) {
                usersList.innerHTML = '<div class="no-records" style="padding: 20px 0;">Nessun utente inserito</div>';
            } else {
                usersList.innerHTML = utenti.map(email => {
                    const utente = usersDB[email];
                    return `
                        <div class="user-item">
                            <div class="user-info" onclick="usaUtenteLogin('${email}')">
                                <div class="user-email">${email}</div>
                                <div class="user-role">${utente.ruolo}</div>
                                <div class="user-org">${utente.organizzazione}</div>
                            </div>
                            <button class="btn-delete-user" onclick="eliminaUtenteLogin('${email}')">üóëÔ∏è Elimina</button>
                        </div>
                    `;
                }).join('');
            }
        }

        function toggleAddUserForm() {
            const form = document.getElementById('addUserForm');
            form.classList.toggle('show');
        }

        function toggleAddUserFormAdmin() {
            const form = document.getElementById('addUserFormAdmin');
            form.classList.toggle('show');
        }

        function aggiungiUtente(event) {
            event.preventDefault();
            const email = document.getElementById('newEmail').value.toLowerCase();
            const password = document.getElementById('newPassword').value;
            const nome = document.getElementById('newNome').value;
            const ruolo = document.getElementById('newRuolo').value;
            const organizzazione = document.getElementById('newOrg').value;

            if (usersDB[email]) {
                mostraAlertLogin2('‚ùå Email gi√† presente!', 'error');
                return;
            }

            const avatar = nome.split(' ').map(p => p[0]).join('').toUpperCase().slice(0, 2);
            usersDB[email] = { password, nome, ruolo, avatar, organizzazione };
            salvaInLocalStorage();
            aggiornaListaUtentiLogin();

            document.getElementById('newEmail').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newNome').value = '';
            document.getElementById('newRuolo').value = '';
            document.getElementById('newOrg').value = '';
            toggleAddUserForm();
            mostraAlertLogin2(`‚úÖ Utente "${nome}" aggiunto!`, 'success');
        }

        function aggiungiUtenteAdmin(event) {
            event.preventDefault();
            const email = document.getElementById('adminNewEmail').value.toLowerCase();
            const password = document.getElementById('adminNewPassword').value;
            const nome = document.getElementById('adminNewNome').value;
            const ruolo = document.getElementById('adminNewRuolo').value;
            const organizzazione = document.getElementById('adminNewOrg').value;

            if (usersDB[email]) {
                mostraAlert('‚ùå Email gi√† presente!', 'error');
                return;
            }

            const avatar = nome.split(' ').map(p => p[0]).join('').toUpperCase().slice(0, 2);
            usersDB[email] = { password, nome, ruolo, avatar, organizzazione };
            salvaInLocalStorage();
            aggiornaListaUtentiAdmin();

            document.getElementById('adminNewEmail').value = '';
            document.getElementById('adminNewPassword').value = '';
            document.getElementById('adminNewNome').value = '';
            document.getElementById('adminNewRuolo').value = '';
            document.getElementById('adminNewOrg').value = '';
            toggleAddUserFormAdmin();
            mostraAlert(`‚úÖ Utente "${nome}" aggiunto!`, 'success');
        }

        function aggiornaListaUtentiAdmin() {
            const list = document.getElementById('adminUsersList');
            const utenti = Object.keys(usersDB);

            list.innerHTML = utenti.map(email => {
                const utente = usersDB[email];
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-email">${email}</div>
                            <div class="user-role">${utente.ruolo}</div>
                            <div class="user-org">${utente.organizzazione}</div>
                        </div>
                        <button class="btn-delete-user" onclick="eliminaUtenteAdmin('${email}')">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        function eliminaUtenteLogin(email) {
            if (confirm(`Eliminare ${email}?`)) {
                delete usersDB[email];
                salvaInLocalStorage();
                aggiornaListaUtentiLogin();
                mostraAlertLogin2('‚úÖ Utente eliminato!', 'success');
            }
        }

        function eliminaUtenteAdmin(email) {
            if (confirm(`Eliminare ${email}?`)) {
                delete usersDB[email];
                salvaInLocalStorage();
                aggiornaListaUtentiAdmin();
                mostraAlert('‚úÖ Utente eliminato!', 'success');
            }
        }

        function usaUtenteLogin(email) {
            document.getElementById('username').value = email;
            document.getElementById('password').focus();
        }

        function esportaUtentiJSON() {
            const dataStr = JSON.stringify(usersDB, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `CSI_Utenti_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            mostraAlertLogin2('‚úÖ Utenti esportati!', 'success');
        }

        function importaUtentiJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedUsers = JSON.parse(e.target.result);
                    usersDB = { ...usersDB, ...importedUsers };
                    salvaInLocalStorage();
                    aggiornaListaUtentiLogin();
                    mostraAlertLogin2(`‚úÖ Importati ${Object.keys(importedUsers).length} utenti!`, 'success');
                    document.getElementById('fileInput').value = '';
                } catch (error) {
                    mostraAlertLogin2('‚ùå Errore nell\'importazione!', 'error');
                }
            };
            reader.readAsText(file);
        }

        function effettuaLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            const utente = usersDB[username];

            if (!utente) {
                mostraAlertLogin('‚ùå Email/Username non trovato!', 'error');
                return;
            }

            if (utente.password !== password) {
                mostraAlertLogin('‚ùå Password non corretta!', 'error');
                return;
            }

            if (rememberMe) {
                localStorage.setItem('usuarioRicordato', username);
            }

            const userData = {
                username: username,
                nome: utente.nome,
                ruolo: utente.ruolo,
                avatar: utente.avatar,
                organizzazione: utente.organizzazione,
                loginTime: new Date().toLocaleString('it-IT')
            };

            localStorage.setItem('usuarioLoggato', JSON.stringify(userData));
            currentUserLoggato = userData;

            mostraAlertLogin(`‚úÖ Benvenuto ${utente.nome}!`, 'success');
            setTimeout(() => {
                mostraApp();
            }, 800);
        }

        function accessoGuest() {
            const userData = {
                username: 'ospite',
                nome: 'Ospite',
                ruolo: 'üë• Accesso Ospite',
                avatar: 'OS',
                organizzazione: 'Accesso Limitato',
                loginTime: new Date().toLocaleString('it-IT')
            };
            localStorage.setItem('usuarioLoggato', JSON.stringify(userData));
            currentUserLoggato = userData;
            mostraApp();
        }

        function passwordDimenticata() {
            alert('üîê Password dimenticata?\n\nContatta l\'amministratore: andrea@asst.it');
        }

        function mostraAlertLogin(messaggio, tipo) {
            const alertDiv = document.getElementById('loginAlert');
            alertDiv.innerHTML = `<div class="alert alert-${tipo}">${messaggio}</div>`;
            setTimeout(() => { alertDiv.innerHTML = ''; }, 5000);
        }

        function mostraAlertLogin2(messaggio, tipo) {
            const alertDiv = document.getElementById('loginAlert2');
            alertDiv.innerHTML = `<div class="alert alert-${tipo}">${messaggio}</div>`;
            setTimeout(() => { alertDiv.innerHTML = ''; }, 5000);
        }

        function mostraApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');

            const utente = JSON.parse(localStorage.getItem('usuarioLoggato'));
            document.getElementById('userName').textContent = utente.nome;
            document.getElementById('userRole').textContent = utente.ruolo;
            document.getElementById('userOrg').textContent = utente.organizzazione;
            document.getElementById('userAvatar').textContent = utente.avatar;

            // Mostra admin panel
            const isAdmin = utente.ruolo.includes('Amministratore') || utente.ruolo.includes('Supervisore');
            if (isAdmin) {
                document.getElementById('adminPanel').classList.add('show');
            }

            aggiornaListaPersone();
        }

        function effettuaLogout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                localStorage.removeItem('usuarioLoggato');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('usersContainer').classList.remove('show');
                currentPersonaId = null;
            }
        }

        // ==================== GESTIONE PERSONE ====================
        function mostraFormNuovaPersona() {
            document.getElementById('nuovaPersonaForm').style.display = 'block';
        }

        function nascondiFormNuovaPersona() {
            document.getElementById('nuovaPersonaForm').style.display = 'none';
            document.getElementById('newPersonaNome').value = '';
            document.getElementById('newPersonaCF').value = '';
        }

        function creaPersona() {
            const nome = document.getElementById('newPersonaNome').value;
            const cf = document.getElementById('newPersonaCF').value;

            if (!nome || !cf) {
                mostraAlert('‚ùå Compilare tutti i campi!', 'error');
                return;
            }

            const id = 'persona_' + Date.now();
            personeRilevate[id] = {
                id: id,
                nome: nome,
                codice_fiscale: cf,
                dati: {}
            };

            salvaInLocalStorage();
            nascondiFormNuovaPersona();
            aggiornaPersoneButtons();
            selezionaPersona(id);
            mostraAlert(`‚úÖ Persona "${nome}" creata!`, 'success');
        }

        function aggiornaPersoneButtons() {
            const buttons = document.getElementById('personButtons');
            const persone = Object.values(personeRilevate);

            if (persone.length === 0) {
                buttons.innerHTML = '<div style="color: #999; font-size: 13px;">Nessuna persona aggiunta</div>';
                return;
            }

            buttons.innerHTML = persone.map(p => `
                <button class="person-btn ${p.id === currentPersonaId ? 'active' : ''}" onclick="selezionaPersona('${p.id}')">
                    ${p.nome}
                </button>
            `).join('');
        }

        function selezionaPersona(id) {
            currentPersonaId = id;
            const persona = personeRilevate[id];

            document.getElementById('nome').value = persona.nome;
            document.getElementById('codice-fiscale').value = persona.codice_fiscale;

            // Carica dati salvati
            const dati = persona.dati || {};
            document.getElementById('luogo-nascita').value = dati['luogo-nascita'] || '';
            document.getElementById('data-nascita').value = dati['data-nascita'] || '';
            document.getElementById('stato-civile').value = dati['stato-civile'] || '';
            document.getElementById('cittadinanza').value = dati['cittadinanza'] || '';
            document.getElementById('indirizzo-residenza').value = dati['indirizzo-residenza'] || '';
            document.getElementById('indirizzo-domicilio').value = dati['indirizzo-domicilio'] || '';
            document.getElementById('telefono').value = dati['telefono'] || '';
            document.getElementById('email').value = dati['email'] || '';

            aggiornaPersoneButtons();
        }

        function salvaPersona() {
            if (!currentPersonaId) {
                mostraAlert('‚ùå Selezionare una persona!', 'error');
                return;
            }

            const dati = {
                'luogo-nascita': document.getElementById('luogo-nascita').value,
                'data-nascita': document.getElementById('data-nascita').value,
                'stato-civile': document.getElementById('stato-civile').value,
                'cittadinanza': document.getElementById('cittadinanza').value,
                'indirizzo-residenza': document.getElementById('indirizzo-residenza').value,
                'indirizzo-domicilio': document.getElementById('indirizzo-domicilio').value,
                'telefono': document.getElementById('telefono').value,
                'email': document.getElementById('email').value
            };

            personeRilevate[currentPersonaId].dati = dati;
            salvaInLocalStorage();
            mostraAlert('‚úÖ Persona salvata!', 'success');
        }

        function prossimaPersona() {
            salvaPersona();
            mostraFormNuovaPersona();
            document.getElementById('newPersonaNome').focus();
        }

        function aggiornaListaPersone() {
            const list = document.getElementById('personList');
            const persone = Object.values(personeRilevate);

            if (persone.length === 0) {
                list.innerHTML = '<div class="no-records"><div class="no-records">Nessuna persona rilevata</div></div>';
                return;
            }

            list.innerHTML = persone.map(p => `
                <div class="record-item">
                    <div class="record-info">
                        <div class="record-name">üë§ ${p.nome}</div>
                        <div class="record-details">
                            <strong>CF:</strong> ${p.codice_fiscale}<br>
                            <strong>Data creazione:</strong> ${new Date(parseInt(p.id.split('_')[1])).toLocaleString('it-IT')}
                        </div>
                    </div>
                    <div class="record-buttons">
                        <button class="record-btn record-btn-view" onclick="viewPersona('${p.id}')">üëÅÔ∏è Visualizza</button>
                        <button class="record-btn record-btn-edit" onclick="selezionaPersonaPerEdit('${p.id}')">‚úèÔ∏è Modifica</button>
                        <button class="record-btn record-btn-delete" onclick="eliminaPersona('${p.id}')">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `).join('');
        }

        function viewPersona(id) {
            const p = personeRilevate[id];
            const dati = p.dati || {};

            const content = `
                <div class="record-details" style="line-height: 1.8;">
                    <strong>Nome:</strong> ${p.nome}<br>
                    <strong>Codice Fiscale:</strong> ${p.codice_fiscale}<br>
                    <strong>Luogo di nascita:</strong> ${dati['luogo-nascita'] || '-'}<br>
                    <strong>Data di nascita:</strong> ${dati['data-nascita'] || '-'}<br>
                    <strong>Stato civile:</strong> ${dati['stato-civile'] || '-'}<br>
                    <strong>Cittadinanza:</strong> ${dati['cittadinanza'] || '-'}<br>
                    <strong>Indirizzo residenza:</strong> ${dati['indirizzo-residenza'] || '-'}<br>
                    <strong>Indirizzo domicilio:</strong> ${dati['indirizzo-domicilio'] || '-'}<br>
                    <strong>Telefono:</strong> ${dati['telefono'] || '-'}<br>
                    <strong>Email:</strong> ${dati['email'] || '-'}<br>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn-primary" onclick="closeViewModal()">Chiudi</button>
                </div>
            `;

            document.getElementById('viewModalContent').innerHTML = content;
            document.getElementById('viewModal').classList.add('show');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('show');
        }

        function selezionaPersonaPerEdit(id) {
            switchTab('rilevamenti');
            selezionaPersona(id);
            window.scrollTo(0, 0);
        }

        function eliminaPersona(id) {
            const p = personeRilevate[id];
            if (confirm(`Eliminare la persona ${p.nome}?`)) {
                delete personeRilevate[id];
                salvaInLocalStorage();
                if (currentPersonaId === id) currentPersonaId = null;
                aggiornaPersoneButtons();
                aggiornaListaPersone();
                mostraAlert('‚úÖ Persona eliminata!', 'success');
            }
        }

        function pulisciSezione() {
            document.getElementById('luogo-nascita').value = '';
            document.getElementById('data-nascita').value = '';
            document.getElementById('stato-civile').value = '';
            document.getElementById('cittadinanza').value = '';
            document.getElementById('indirizzo-residenza').value = '';
            document.getElementById('indirizzo-domicilio').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('email').value = '';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleUsersManagement() {
            const modal = document.getElementById('usersModal');
            modal.classList.toggle('show');
            if (modal.classList.contains('show')) {
                aggiornaListaUtentiAdmin();
            }
        }

        function esportaRilevamenti() {
            const data = {
                utente: currentUserLoggato,
                persone: personeRilevate,
                data_export: new Date().toLocaleString('it-IT')
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `CSI_Rilevamenti_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            mostraAlert('‚úÖ Dati esportati!', 'success');
        }

        function importaRilevamenti() {
            document.getElementById('fileInputApp').click();
        }

        function importaRilevamentiFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    personeRilevate = { ...personeRilevate, ...data.persone };
                    salvaInLocalStorage();
                    aggiornaPersoneButtons();
                    aggiornaListaPersone();
                    mostraAlert(`‚úÖ Importate ${Object.keys(data.persone).length} persone!`, 'success');
                    document.getElementById('fileInputApp').value = '';
                } catch (error) {
                    mostraAlert('‚ùå Errore nell\'importazione!', 'error');
                }
            };
            reader.readAsText(file);
        }

        function mostraAlert(messaggio, tipo) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo}`;
            alert.textContent = messaggio;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.maxWidth = '400px';
            document.body.appendChild(alert);

            setTimeout(() => { alert.remove(); }, 4000);
        }

        // ==================== INIT ====================
        window.addEventListener('load', function() {
            caricaDati();
            aggiornaListaUtentiLogin();

            const utente = localStorage.getItem('usuarioLoggato');
            const usuarioRicordato = localStorage.getItem('usuarioRicordato');

            if (utente) {
                mostraApp();
            } else if (usuarioRicordato) {
                document.getElementById('username').value = usuarioRicordato;
                document.getElementById('password').focus();
            }
        });
    </script>
</body>
</html>