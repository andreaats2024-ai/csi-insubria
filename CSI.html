<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartella Sociale CSI - ATS Insubria</title>
    <meta name="description" content="Cartella Sociale Informatizzata - demo con Firebase Authentication e Realtime Database">
    <style>
        :root{--color-primary:#208091;--color-primary-hover:#1a6b78;--color-bg:#f5f5f5;--color-surface:#fff;--color-text:#2c3e50;--color-text-light:#7f8c8d;--color-border:#ecf0f1;--color-success:#27ae60;--color-error:#e74c3c;--color-info:#3498db}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:var(--color-bg);color:var(--color-text);line-height:1.6}
        .header{background:linear-gradient(135deg,var(--color-primary) 0%,var(--color-primary-hover)100%);color:#fff;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .container{max-width:1200px;margin:20px auto;padding:20px}
        .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center}
        .card{background:var(--color-surface);border-radius:10px;padding:22px;box-shadow:0 8px 30px rgba(0,0,0,.08);width:100%;max-width:720px}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        label{display:block;font-size:13px;margin-bottom:6px;color:var(--color-text)}
        input,select,textarea{width:100%;padding:10px;border:1px solid var(--color-border);border-radius:6px;font-size:14px}
        button{padding:10px 14px;border-radius:6px;border:none;cursor:pointer}
        .btn-primary{background:var(--color-primary);color:#fff}
        .btn-secondary{background:#f0f0f0;color:var(--color-text)}
        .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
        .tab-btn{padding:8px 12px;border-radius:6px;border:none;background:#fff;border:1px solid var(--color-border);cursor:pointer}
        .tab-btn.active{outline:2px solid rgba(32,128,145,.12);border-color:var(--color-primary)}
        .tab-content{display:none;background:var(--color-surface);padding:16px;border-radius:8px}
        .tab-content.active{display:block}
        .button-group{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
        table{width:100%;border-collapse:collapse;margin-top:8px}
        th,td{padding:8px;border-bottom:1px solid var(--color-border);text-align:left}
        .info{background:#eef7f8;border-left:4px solid var(--color-info);padding:10px;border-radius:6px;margin-bottom:10px}
        .status{padding:10px;border-radius:6px;margin-bottom:12px;display:none}
        .status.show{display:block}
        .status.success{background:#dff0e0;color:#0b6b3a}
        .status.error{background:#fbeaea;color:#7a1d1d}
        @media(max-width:800px){.grid{grid-template-columns:1fr}.container{padding:12px}}
    </style>
</head>
<body>
    <!-- LOGIN / REGISTER -->
    <div id="loginScreen" class="login-screen">
        <div class="card">
            <h2 style="color:var(--color-primary)">üè• CSI - Cartella Sociale</h2>
            <p style="color:var(--color-text-light);margin-bottom:12px">Accesso operatori (Firebase Authentication)</p>

            <div id="authStatus" class="status" role="status"></div>

            <div style="display:flex;gap:12px;margin-bottom:14px">
                <button id="showLogin" class="tab-btn active">Accedi</button>
                <button id="showRegister" class="tab-btn">Registrati</button>
            </div>

            <div id="loginBox">
                <div class="grid">
                    <div>
                        <label for="loginEmail">Email</label>
                        <input id="loginEmail" type="email" autocomplete="username" placeholder="operatore@asst.it">
                    </div>
                    <div>
                        <label for="loginPassword">Password</label>
                        <input id="loginPassword" type="password" autocomplete="current-password" placeholder="password">
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
                    <input id="rememberMe" type="checkbox"><label for="rememberMe">Ricordami (local)</label>
                </div>
                <div class="button-group" style="justify-content:flex-start;margin-top:12px">
                    <button class="btn-primary" id="btnLogin">üîì Accedi</button>
                    <button class="btn-secondary" id="btnResetPassword">‚úâÔ∏è Password Dimenticata</button>
                </div>
            </div>

            <div id="registerBox" style="display:none;margin-top:12px">
                <div class="grid">
                    <div>
                        <label for="regName">Nome e Cognome</label>
                        <input id="regName" type="text" placeholder="Nome Cognome">
                    </div>
                    <div>
                        <label for="regEmail">Email</label>
                        <input id="regEmail" type="email" autocomplete="email" placeholder="nuovo@asst.it">
                    </div>
                </div>
                <div class="grid" style="margin-top:8px">
                    <div>
                        <label for="regPassword">Password</label>
                        <input id="regPassword" type="password" placeholder="password">
                    </div>
                    <div>
                        <label for="regConfirm">Conferma Password</label>
                        <input id="regConfirm" type="password" placeholder="conferma password">
                    </div>
                </div>
                <div class="button-group" style="justify-content:flex-start;margin-top:12px">
                    <button class="btn-primary" id="btnRegister">‚úì Registrati</button>
                </div>
            </div>

            <div style="margin-top:16px;font-size:12px;color:var(--color-text-light)">
                <strong>Credenziali Demo</strong><br>
                demo@asst.it / demo123 (esempio)
            </div>
        </div>
    </div>

    <!-- MAIN APP (protetta da auth) -->
    <div id="mainScreen" style="display:none">
        <div class="header">
            <div class="container" style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <h1 style="margin:0">üè• Cartella Sociale Informatizzata (CSI)</h1>
                    <small style="color:var(--color-text-light)">ATS Insubria</small>
                </div>
                <div style="display:flex;align-items:center;gap:12px">
                    <div id="userDisplay" style="color:#fff;background:rgba(0,0,0,.12);padding:6px 10px;border-radius:6px"></div>
                    <button id="btnLogout" class="btn-secondary">üîê Esci</button>
                </div>
            </div>
        </div>

        <div class="container">
            <div id="message" class="status"></div>

            <div class="tabs" id="tabs">
                <button class="tab-btn active" data-tab="anagrafica">1. Anagrafica</button>
                <button class="tab-btn" data-tab="interventi">2. Interventi</button>
                <button class="tab-btn" data-tab="autosufficienza">3. Autosufficienza</button>
                <button class="tab-btn" data-tab="abitativa">4. Socio-Abitativa</button>
                <button class="tab-btn" data-tab="economica">5. Socio-Economica</button>
                <button class="tab-btn" data-tab="familiare">6. Socio-Familiare</button>
                <button class="tab-btn" data-tab="giuridica">7. Protezione Giuridica</button>
            </div>

            <!-- ANAGRAFICA (solo campi principali per esempio) -->
            <div id="anagrafica" class="tab-content active">
                <h3>1. Dati Anagrafici</h3>
                <div class="grid">
                    <div>
                        <label>Nome e Cognome</label>
                        <input name="nome_cognome" type="text">
                    </div>
                    <div>
                        <label>Data di nascita</label>
                        <input name="data_nascita" type="date">
                    </div>
                </div>
                <div class="grid" style="margin-top:10px">
                    <div>
                        <label>Codice Fiscale</label>
                        <input name="codice_fiscale" type="text" placeholder="XXXXXX00X00X000X">
                    </div>
                    <div>
                        <label>Telefono</label>
                        <input name="telefono" type="tel">
                    </div>
                </div>
                <div style="margin-top:12px" class="button-group">
                    <button class="btn-secondary" onclick="resetForm('anagrafica')">Pulisci</button>
                    <button class="btn-primary" onclick="salvaSezione('anagrafica')">Salva Sezione</button>
                </div>
            </div>

            <!-- INTERVENTI (esempio) -->
            <div id="interventi" class="tab-content">
                <h3>2. Interventi</h3>
                <div class="info">Indicare gli interventi sanitari, socio-sanitari e sociali attualmente attivi.</div>
                <div>
                    <label>Note interventi</label>
                    <textarea name="interventi_sanitari_spec"></textarea>
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="resetForm('interventi')">Pulisci</button>
                    <button class="btn-primary" onclick="salvaSezione('interventi')">Salva Sezione</button>
                </div>
            </div>

            <!-- altri tab: autosufficienza, abitativa, economica, familiare, giuridica -->
            <div id="autosufficienza" class="tab-content">
                <h3>3. Autosufficienza</h3>
                <label>ADL (punteggio)</label>
                <input name="adl_score" type="number" min="0" max="100">
                <div class="button-group">
                    <button class="btn-secondary" onclick="resetForm('autosufficienza')">Pulisci</button>
                    <button class="btn-primary" onclick="salvaSezione('autosufficienza')">Salva Sezione</button>
                </div>
            </div>

            <div id="abitativa" class="tab-content">
                <h3>4. Condizione Socio-Abitativa</h3>
                <label>Tipo di alloggio</label>
                <select name="tipo_alloggio"><option value="">-- Seleziona --</option><option value="proprieta">Propriet√†</option><option value="affitto">Affitto</option></select>
                <div class="button-group">
                    <button class="btn-secondary" onclick="resetForm('abitativa')">Pulisci</button>
                    <button class="btn-primary" onclick="salvaSezione('abitativa')">Salva Sezione</button>
                </div>
            </div>

            <div id="economica" class="tab-content">
                <h3>5. Condizione Socio-Economica</h3>
                <label>Valore ISEE</label>
                <input name="valore_isee" type="number" step="0.01">
                <div class="button-group">
                    <button class="btn-secondary" onclick="resetForm('economica')">Pulisci</button>
                    <button class="btn-primary" onclick="salvaSezione('economica')">Salva Sezione</button>
                </div>
            </div>

            <div id="familiare" class="tab-content">
                <h3>6. Condizione Socio-Familiare</h3>
                <label>Composizione nucleo</label>
                <select name="composizione_nucleo"><option value="">--</option><option value="solo">Solo</option><option value="coniuge">Coniuge</option></select>
                <div class="button-group">
                    <button class="btn-secondary" onclick="resetForm('familiare')">Pulisci</button>
                    <button class="btn-primary" onclick="salvaSezione('familiare')">Salva Sezione</button>
                </div>
            </div>

            <div id="giuridica" class="tab-content">
                <h3>7. Protezione Giuridica</h3>
                <label>Amministratore di sostegno</label>
                <input name="amm_sostegno_nome" type="text">
                <div class="button-group">
                    <button class="btn-secondary" onclick="resetForm('giuridica')">Pulisci</button>
                    <button class="btn-primary" onclick="salvaSezione('giuridica')">Salva Sezione</button>
                </div>
            </div>

            <!-- Azioni globali -->
            <div style="margin-top:18px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                <button class="btn-primary" onclick="salvaCompleto()">üíæ Salva Cartella Completa</button>
                <button class="btn-secondary" onclick="esportaDati()">üì• Esporta JSON</button>
                <button class="btn-secondary" onclick="document.getElementById('fileImport').click()">üì§ Importa JSON</button>
                <input id="fileImport" type="file" accept="application/json" style="display:none" onchange="importaDati(event)">
                <button class="btn-secondary" onclick="visualizzaUtenti()">üë• Vedi Utenti</button>
            </div>

            <div id="modalUtenti" style="display:none;margin-top:14px;background:#fff;padding:12px;border-radius:8px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <h4>Database Pazienti</h4>
                    <button onclick="closeUtenti()">Chiudi</button>
                </div>
                <input id="cercaUtente" placeholder="Cerca per CF o nome" style="margin-top:8px;padding:8px;border:1px solid var(--color-border);border-radius:6px">
                <div style="overflow:auto;max-height:300px;margin-top:8px">
                    <table id="tabellaUtenti"><thead><tr><th>CF</th><th>Nome</th><th>Telefono</th><th>Azioni</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (compat per semplicit√†) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
    // ====== CONFIGURAZIONE FIREBASE - SOSTITUISCI CON I TUOI VALORI ======
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT.firebaseio.com",
        projectId: "YOUR_PROJECT",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    // =====================================================================

    // UI helpers
    function showMessage(text, type = 'success'){
        const el = document.getElementById('message');
        el.textContent = text; el.className = 'status show ' + (type==='error' ? 'error' : 'success');
        setTimeout(()=>{el.className = 'status';},4000);
    }

    function setAuthStatus(text, type=''){
        const el = document.getElementById('authStatus');
        el.textContent = text; el.className = 'status show ' + (type==='error' ? 'error' : 'success');
        setTimeout(()=>{el.className = 'status';},3500);
    }

    // Toggle login/register UI
    document.getElementById('showLogin').addEventListener('click', ()=>{document.getElementById('loginBox').style.display='block';document.getElementById('registerBox').style.display='none';document.getElementById('showLogin').classList.add('active');document.getElementById('showRegister').classList.remove('active');});
    document.getElementById('showRegister').addEventListener('click', ()=>{document.getElementById('loginBox').style.display='none';document.getElementById('registerBox').style.display='block';document.getElementById('showLogin').classList.remove('active');document.getElementById('showRegister').classList.add('active');});

    // Auth actions
    document.getElementById('btnLogin').addEventListener('click', async ()=>{
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPassword').value;
        try{
            await auth.signInWithEmailAndPassword(email, pass);
            setAuthStatus('Accesso effettuato');
            if(document.getElementById('rememberMe').checked) localStorage.setItem('rememberEmail', email);
        }catch(err){ setAuthStatus('Errore login: '+err.message,'error'); }
    });

    document.getElementById('btnRegister').addEventListener('click', async ()=>{
        const name = document.getElementById('regName').value;
        const email = document.getElementById('regEmail').value;
        const pass = document.getElementById('regPassword').value;
        const confirm = document.getElementById('regConfirm').value;
        if(!name || !email || !pass){ setAuthStatus('Compila tutti i campi','error'); return; }
        if(pass !== confirm){ setAuthStatus('Le password non corrispondono','error'); return; }
        try{
            const userCred = await auth.createUserWithEmailAndPassword(email, pass);
            // salva il displayName
            await userCred.user.updateProfile({ displayName: name });
            setAuthStatus('Registrazione completata');
        }catch(err){ setAuthStatus('Errore registrazione: '+err.message,'error'); }
    });

    document.getElementById('btnResetPassword').addEventListener('click', async ()=>{
        const email = document.getElementById('loginEmail').value;
        if(!email){ setAuthStatus('Inserisci email per recupero','error'); return; }
        try{ await auth.sendPasswordResetEmail(email); setAuthStatus('Email recupero inviata'); }catch(err){ setAuthStatus('Errore: '+err.message,'error'); }
    });

    document.getElementById('btnLogout').addEventListener('click', async ()=>{ await auth.signOut(); });

    // Protezione UI
    auth.onAuthStateChanged(user => {
        if(user){
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('userDisplay').textContent = user.displayName || user.email;
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
        }
    });

    // TAB handling
    document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            btn.classList.add('active');
            const id = btn.getAttribute('data-tab');
            document.getElementById(id).classList.add('active');
        });
    });

    // Utility: reset specific tab
    function resetForm(tabId){
        const el = document.getElementById(tabId);
        if(!el) return;
        el.querySelectorAll('input,select,textarea').forEach(i=>{
            if(i.type === 'checkbox' || i.type === 'radio'){ i.checked = false; } else { i.value = ''; }
        });
        showMessage('Modulo ripristinato', 'success');
    }

    // Salva sezione -> usa codice fiscale come chiave
    function salvaSezione(sezione){
        const container = document.getElementById(sezione);
        if(!container){ showMessage('Sezione non trovata','error'); return; }
        const fields = container.querySelectorAll('input,select,textarea');
        const payload = {};
        fields.forEach(f=>{
            if(!f.name) return;
            if(f.type === 'checkbox') payload[f.name] = f.checked;
            else payload[f.name] = f.value || '';
        });
        // aggiungi data inserimento
        payload.dataInserimento = new Date().toISOString();

        // prendi codice fiscale dal form anagrafica
        const cf = document.querySelector('#anagrafica input[name="codice_fiscale"]').value;
        if(!cf){ showMessage('Inserire il Codice Fiscale nel form Anagrafica prima di salvare','error'); return; }

        db.ref('pazienti/' + cf + '/' + sezione).set(payload)
        .then(()=> showMessage('Sezione salvata','success'))
        .catch(e=> showMessage('Errore salvataggio: '+e.message,'error'));
    }

    // Salva cartella completa
    async function salvaCompleto(){
        const allTabs = document.querySelectorAll('.tab-content');
        const record = {};
        let cf = '';
        allTabs.forEach(tab=>{
            const id = tab.id;
            record[id] = {};
            tab.querySelectorAll('input,select,textarea').forEach(f=>{
                if(!f.name) return;
                if(f.type === 'checkbox') record[id][f.name] = f.checked;
                else record[id][f.name] = f.value || '';
                if(id === 'anagrafica' && f.name === 'codice_fiscale') cf = f.value;
            });
        });
        if(!cf){ showMessage('Inserire il Codice Fiscale prima di salvare la cartella','error'); return; }
        record.meta = { lastSaved: new Date().toISOString(), savedBy: auth.currentUser?.email || 'anon' };
        try{
            await db.ref('pazienti/' + cf).set(record);
            showMessage('Cartella salvata con successo','success');
        }catch(e){ showMessage('Errore: '+e.message,'error'); }
    }

    // Lista pazienti
    function visualizzaUtenti(){
        document.getElementById('modalUtenti').style.display = 'block';
        const tbody = document.querySelector('#tabellaUtenti tbody'); tbody.innerHTML = '';
        db.ref('pazienti').once('value').then(snap=>{
            if(!snap.exists()){ tbody.innerHTML = '<tr><td colspan="4">Nessun paziente</td></tr>'; return; }
            snap.forEach(child=>{
                const cf = child.key;
                const anag = (child.val().anagrafica) || {};
                const row = document.createElement('tr');
                row.innerHTML = `<td>${cf}</td><td>${anag.nome_cognome || '-'}</td><td>${anag.telefono||'-'}</td><td><button onclick="caricaPaziente('${cf}')">Apri</button> <button onclick="eliminaPaziente('${cf}')">Elimina</button></td>`;
                tbody.appendChild(row);
            });
        }).catch(e=> showMessage('Errore lettura DB: '+e.message,'error'));
    }

    function closeUtenti(){ document.getElementById('modalUtenti').style.display='none'; }

    // Carica paziente
    function caricaPaziente(cf){
        db.ref('pazienti/' + cf).once('value').then(snap=>{
            if(!snap.exists()){ showMessage('Paziente non trovato','error'); return; }
            const data = snap.val();
            Object.keys(data).forEach(section=>{
                const container = document.getElementById(section);
                if(!container) return;
                container.querySelectorAll('input,select,textarea').forEach(f=>{
                    if(f.name && data[section][f.name] !== undefined){
                        if(f.type === 'checkbox') f.checked = !!data[section][f.name]; else f.value = data[section][f.name];
                    }
                });
            });
            showMessage('Dati caricati per ' + cf,'success');
        }).catch(e=> showMessage('Errore caricamento: '+e.message,'error'));
    }

    function eliminaPaziente(cf){
        if(!confirm('Eliminare definitivamente il paziente ' + cf + ' ?')) return;
        db.ref('pazienti/' + cf).remove().then(()=>{ showMessage('Paziente eliminato','success'); visualizzaUtenti(); }).catch(e=> showMessage('Errore eliminazione: '+e.message,'error'));
    }

    // Export / Import JSON (client-side)
    function esportaDati(){
        const cf = document.querySelector('#anagrafica input[name="codice_fiscale"]').value;
        if(!cf){ showMessage('Inserire CF per esportare la cartella','error'); return; }
        db.ref('pazienti/' + cf).once('value').then(snap=>{
            if(!snap.exists()){ showMessage('Nessuna cartella per questo CF','error'); return; }
            const data = snap.val();
            const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `cartella_${cf}.json`; a.click(); URL.revokeObjectURL(url);
        }).catch(e=> showMessage('Errore export: '+e.message,'error'));
    }

    function importaDati(evt){
        const file = evt.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e=>{
            try{
                const data = JSON.parse(e.target.result);
                // richiede CF nel file o nel form
                const cfInFile = Object.keys(data).length && data.anagrafica && data.anagrafica.codice_fiscale ? data.anagrafica.codice_fiscale : null;
                const cf = cfInFile || document.querySelector('#anagrafica input[name="codice_fiscale"]').value;
                if(!cf){ showMessage('CF non trovato. Inserisci CF nel form o nel file JSON','error'); return; }
                db.ref('pazienti/' + cf).set(data).then(()=> showMessage('Importazione completata','success')).catch(e=> showMessage('Errore import: '+e.message,'error'));
            }catch(e){ showMessage('File JSON non valido','error'); }
        };
        reader.readAsText(file);
    }

    // inizializzazione: pre-fill se remembered
    window.addEventListener('load', ()=>{
        const rem = localStorage.getItem('rememberEmail');
        if(rem) document.getElementById('loginEmail').value = rem;
    });

    </script>
</body>
</html>
